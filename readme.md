ver.0.0.1 (2014/04/14)

# Node.jsサンプルチャット

Node.jsのリアルタイム通信を体験するための簡易サンプルです。  
2014年4月時点の最新バージョンで環境構築しています。

 * Node.js v0.10.26
 * npm v1.4.3（パッケージ管理ツール）
 * express v4.0.0（Node.jsのアプリケーションフレームワーク）
 * Socket.IO v0.9.16（WebSocketを使うためのNode.jsモジュール）

この手順で進めました。

 * 起動環境の準備
 * このサンプルソースを起動環境に合わせて編集
 * 起動
 * さわってみる

## 起動環境

 * Node.js と npm がインストールされている
 * npm がインストールされている

Windows 7で作成しました。  
ローカル環境で動作するサンプルなので、Node.jsやnpmを使います。  
パソコンにインストールされていない場合は、以下の手順で導入してください。


### Node.jsをインストール
Node.jsオフィシャルサイトから、インストーラをダウンロードし実行します。  
2014年4月時点では Current Version: v0.10.26 でした。

http://nodejs.org/

ウィザード実行時に、オプションの選択画面があります。  
デフォルトでnpmもいっしょにインストールするようチェックが入っていますので、そのまま進めます。

### Windows版インストーラは環境変数Pathの設定バグがある
2014年4月時点で配布されているWindwosインストーラは  
システム環境変数のPathを誤った内容で設定してしまうバグがあるので、修正します。

※以下、Node.jsを c:\nodejs へインストールした場合の例です。

> 誤)  C:\nodejs\

誤って末尾へ\が追加されているので

> 正)  C:\nodejs

削除します。

システム環境変数の変更はこの順番で設定できます

1. コンピューター(エクスプローラから)
1. プロパティ(右クリックから)
1. システムの詳細設定（左メニューから）
1. 環境変数（タブ）
1. システム環境変数のPath（一覧の項目を選択）
1. 編集（ボタン）

### インストール確認

インストールが成功しているか確認します。

Node.jsのはコマンドラインで操作するため、  
コマンドプロンプト か Terminal を起動します。


```
$ node -v
```

このコマンドを実行すると、インストール成功していればNode.jsのバージョンが表示されます。


```
$ node -v
v0.10.26
```

## サンプルソースを起動環境に合わせて編集
Gitから、このソース一式をチェックアウトします。  
chatディレクトリ以下が、このサンプルにあたります。

/frontrend/Nodejs/chat

ほぼ、expressで構築されたままの状態です。  
express でスケルトン作成後、注釈が入っているディレクトリやファイルをさわりました。

```
/
├ bin/
├ node_modules/
├ public/　…読み込む画像やスタイルシートなどを格納するディレクトリ
│　├ images
│　├ javascript
│　│　└ chat.js　…クライアント側の設定をするJavascriptファイル
│　└ stylesheets
│　 　└ style.css　…画面のスタイル
├ routes/
├ views/
│　├ error.ejs
│　└ index.ejs　…最初に表示される画面
│
├ app.js　…サーバ側の設定をするJavascriptファイル
├ package.json
└ readme.md　…このファイル

```

### /views/index.ejs
いわゆるindex.html。起動して最初に表示される画面です。    
（ejsはNode.jsのテンプレートエンジン。基本的にHTMLの記法でOK。）  
このファイルはそのままでも動作しますが  
全体の構造をそれとなく把握するのにちょうどいいので少し解説します。

ここへ、HTMLでページを構築する手順と同様にチャット用のHTMLタグを書き  
外部スタイルシート（/stylesheets/style.css）や  
クライアント側のJavascript（/javascripts/chat.js）を読み込んでいます。

```:html
<head>
	<title><%= title %></title>
	<link rel='stylesheet' href='/stylesheets/style.css' />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" type="text/javascript" ></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="/javascripts/chat.js"></script>
</head>
```

** <%= title %> **の部分はejsタグで、/routes/index.jsで定義してある変数を呼び出しています。

また、外部参照のファイルが、/（ルート）パスで参照されているのは  
expressのテンプレートが/publicディレクトリ以下を/（ルート）とする設定になっているためです。
（この設定はapp.js内に書いてあります）

7行目で読み込んでいる** socket.io.js **はSocket.IOを使用する際に必要なJavascriptファイルです。  
このファイルはSocket.IOが自動生成するため、/publicディレクトリ内には実体がありません。

### app.js
サーバ側の設定をしているJavascriptです。  
このapp.jsは、expressでプロジェクト（アプリケーションに必要なファイル一式のセット）作成時にセットになっていたもので  
59行目までは初期設定のままです。  
expressアプリケーションを定義する内容が書かれています。

```:js
var io = require('socket.io').listen(app.listen(1234));　// 1234はポート番号。各自の環境で被っていない番号を設定。

io.sockets.on('connection', function (socket) {
    socket.on('message', function (data) {
        if(data && typeof data.text === 'string') {
            socket.broadcast.json.emit('message', {text: data.text, bandleName: data.bandleName});
        }
    });
});
```

63行目からがSocket.IOの設定で、** 1234はポート番号です **。
既に1234ポートを他のプログラムなどで使用している場合は、3000など他の数値に書き換えます。

63行目でSocket.IOを使用する宣言、アプリケーションとの紐付けを設定しており  
65行目からは、メッセージの投稿があれば投稿元以外のクライアントへ内容を発信するよう設定してあります。

### /public/javascript/chat.js
クライアント側のJavascriptです。  
クライアント側というとややこしいですが、いつもHTMLから読み込んでいるJavascriptのことです。

Socket.IOに関連する記述は3箇所です。

```:js
var socket = io.connect('http://172.16.2.40'); // ここをlocalhostからローカルIPに変更すると、ローカルネットワーク内で連携できる
```
2行目で、このアプリケーションを開くホストを指定しています。  
172.16.2.40 は、作成者パソコンのローカルIPアドレスなので、
localhost や 127.0.0.1 へ書き換えるか、各自のパソコンに合わせたローカルIPに書き換えます。

localhost や 127.0.0.1を指定した場合は、このような記述となり  
自分のパソコン内のみの連携になります。
ブラウザで複数のウィンドウを開き、それらの間でメッセージのやりとりが反映されますが  
他のクライアントとの間ではデータのやりとりができません。

```:js
var socket = io.connect('http://localhost');
```

ここを、172.16.2　…　のようローカルIPに設定すると  
ローカルネットワーク内のパソコン同士でのメッセージをやりとりができるようになります。

自分のパソコンのローカルIPは、以下のコマンドから確認できます。  
コマンドプロンプトやTerminalを起動し、実行してみてください。

```
$ ipconfig
```

13～15行目は、app.jsでも設定した  
他クライアントで投稿されたメッセージを受信している部分で

22～25行目は、メッセージを送信している部分です。

## 起動
Node.jsのアプリケーションは、サーバを起動しないと実行できません。
Node.jsの操作は、コマンドラインから行います。  

コマンドラインのアプリケーション（コマンドプロンプトやTerminal）を起動後  
このチャットサンプルのアプリケーションをチェックアウトしたディレクトリまで移動します。

※以下、C:\_works\chat へチェックアウトした場合の例です。

```
$ cd C:\_works\chat
```

その後、Node.jsのコマンドで先ほど編集したapp.jsを呼び出すことでサーバを起動します。

```
$ node app.js
```

app.jsの内容に問題がなければ、続いてSocket.IOからのメッセージが表示されます。

```
$ node app.js
   info  - socket.io started
```

なお、サーバを終了させる時は、コマンドラインで ** Ctrl + c ** を入力します。

webブラウザで、 http://localhost:1234 を開くとチャット画面が起動します。  
（前の手順でポート番号を1234意外に書き換えている場合は、その番号に置き換えてください）

最初の起動の場合はおそらく、ブラウザへ  
*** /socket.io/socket.io.js が見つからないです ***  
といった内容の404エラーが出ています。

これは、Socket.IOのファイルに不足があるためなので  
npmのアプリケーション内の不足データを自動補完してくれるコマンドを実行します。

サーバが起動したままだと、コマンドを実行できないため  
Ctrl + c　で、いったん終了させます。

その後、以下の補完コマンドを実行します。

```
$ npm install -d
```

※このコマンドは、コマンドライ上でNode.jsアプリケーションのあるディレクトリがルートになっている場合のみ有効です。  
Node.jsアプリケーションのあるディレクトリ = app.js が置いてあるディレクトリ です。

コマンドを実行すると、不足データが/node_modulesディレクトリ内へ追加されます。  
再度、node app.js でサーバを起動し、404エラーが出ていないか確認してみてください。

## さわってみる
Node.jsのサーバ起動後、webブラウザのウィンドウを複数起動して  
http://localhost:1234 を開きます。

ここで、メッセージを入力すると  
入力した画面意外でもリアルタイムに投稿内容が表示されるところを確認できます。

/public/javascript/chat.js で、localhostではなくローカルIPを設定している場合は  
ローカルネットワーク内の他のパソコン（いわゆる、同じルータやWiFiスポットを介してインターネット接続しているパソコン）からも
http://xxx.xx.x.xx:1234 のようアドレスを入力すれば、ブラウザからチャットの画面を開けます。  
(xxx.xx.x.xxのところは、app.jsを設置しているパソコンのローカルIPに置き換えてください)

この場合、ローカルネットワークの他のパソコンとも非同期通信できますので  
入力した（された）メッセージが即時反映されます。

---
ver.0.0.1 (2014/04/14)
